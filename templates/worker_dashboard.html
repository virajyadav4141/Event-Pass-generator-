<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Worker Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
#scan_result {
  font-size: 1.2rem;
  font-weight: bold;
  margin-top: 10px;
  min-height: 30px;
}
.success { color: green; }
.error { color: red; }
</style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Worker Dashboard</h3>
    <a class="btn btn-secondary" href="{{ url_for('logout') }}">Logout</a>
  </div>

  <div class="card p-3 shadow-sm mb-3">
    <h5>Scan Pass</h5>
    <div id="qr-reader" style="width:300px"></div>
    <div class="mt-2">
      <input type="text" id="manual_pass" class="form-control" placeholder="Manual Pass Entry">
      <button class="btn btn-primary btn-sm mt-1" onclick="manualEntry()">Submit</button>
    </div>
    <div id="scan_result"></div>
  </div>

  <div class="card p-3 shadow-sm">
    <h5>Entry Report</h5>
    <table class="table table-bordered">
      <thead>
        <tr><th>Event</th><th>Used</th><th>Remaining</th></tr>
      </thead>
      <tbody id="report_body"></tbody>
    </table>
  </div>
</div>

<script>
function fetchReport(){
  axios.get('{{ url_for("worker_report") }}')
  .then(res=>{
    let body='';
    res.data.forEach(r=>{
      body+=`<tr><td>${r.event}</td><td>${r.used}</td><td>${r.remaining}</td></tr>`;
    });
    document.getElementById('report_body').innerHTML=body;
  });
}
fetchReport();

// Display scan result for 10 seconds
function showResult(message, type){
  const div = document.getElementById('scan_result');
  div.innerHTML = message;
  div.className = type;
  setTimeout(()=>{ div.innerHTML=''; div.className=''; }, 10000);
}

function manualEntry(){
  const code=document.getElementById('manual_pass').value;
  if(!code) return;
  axios.post('{{ url_for("manual_entry") }}', {pass_code: code})
  .then(res=>{
    if(res.data.status==='success'){
      showResult('✅ ' + res.data.message, 'success');
    } else {
      showResult('⚠ ' + res.data.message, 'error');
    }
    document.getElementById('manual_pass').value='';
    fetchReport();
  });
}

function onScanSuccess(decodedText, decodedResult){
  axios.post('{{ url_for("manual_entry") }}', {pass_code: decodedText})
  .then(res=>{
    if(res.data.status==='success'){
      showResult('✅ ' + res.data.message, 'success');
    } else {
      showResult('⚠ ' + res.data.message, 'error');
    }
    fetchReport();
  });
}

function onScanFailure(error){ /* ignore errors */ }

new Html5QrcodeScanner("qr-reader",{fps:10,qrbox:250}).render(onScanSuccess,onScanFailure);
</script>
</body>
</html>
